<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Classroom Schedule</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">


    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.2/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.0.1/fullcalendar.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.0.1/fullcalendar.min.css" />
    <link rel="stylesheet" media="print" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.0.1/fullcalendar.print.css" />

    <style>
    .page-header { padding: 0; }
    #form-bar { display: flex; padding: 1em .5em; width:100% }
    #add-teacher-form { }
    #add-student-form { }
    #add-teacher-form form, #add-student-form form { display: inline-block; padding-left: 1em; }
    #weekday-form { flex: 1; text-align: center; }
    .cal { display: block; float: left;  }
    .last-teacher { border-right-width: 4px !important; border-color: black !important; }
    #event-editor { border: 1px solid #999; border-width: 1px 0; padding: 1em 5em; background: aliceblue; }
    #event-editor footer { text-align: right; max-width: 420px; }
    #event-editor label { margin: .2em .5em .2em 0; }
    label { display: inline-block; }
    select[multiple] { vertical-align: top; min-width: 100%; }
    button[type='reset'] { border: none; background: none; font-size: 0.9em; text-decoration: underline; }
    .page-header a { float: right; margin: 1rem; }


    @media print {
	@page { size: landscape; }
	.no-print { display: none !important; }
    }
    </style>

  </head>
  <body>
    <section class="page-header no-print">
      <a href="#" class='btn' id='clear-all'>Clear All Data</a>
      <a href="https://github.com/JamesMaroney/random-stuff/issues" target="_blank" class='btn'>Report A Problem</a>
      <h1 class="project-name">Classroom Scheduler</h1>
    </section>

    <section>



<div id='form-bar' class="no-print">
	<div id='add-teacher-form'>
		<strong>Add a Teacher:</strong>
		<form id="new-teacher">
			<input name="name" />
			<button type="submit">Add</button>
		</form>
	</div>
	<div id='weekday-form'>
		<label>Weekday: 
			<select id='weekday'>
				<option>Monday</option>
				<option>Tuesday</option>
				<option>Wednesday</option>
				<option>Thursday</option>
				<option>Friday</option>
			</select>
		</label>
	</div>
	<div id='add-student-form'>
		<strong>Add a Student:</strong>
		<form id="new-student">
			<input name="name" />
			<button type="submit">Add</button>
		</form>
	</div>
</div>

<form id="event-editor" style="display:none" class="no-print">
	<strong><span id='addOrEdit'>Add</span> Entry: </strong>
	<input type="hidden" name="id" value="" />
	<label>Activity: <input type="text" name="activity" /></label>
	<br />
	<label>Start Time: <input type="time" name="startTime" /></label>
	<label>End Time: <input type="time" name="endTime" /></label>
	<br />
	<label>Teachers: <br /><select name="teachers" multiple></select></label>
	<label>Students: <br /><select name="students" multiple></select></label>
	<label>Days: <br /><select name="days" multiple> <option>Monday</option> <option>Tuesday</option> <option>Wednesday</option> <option>Thursday</option> <option>Friday</option> </select></label>
	<footer>
		<button type="reset">Reset</button>
		<button type="submit">Save</button>
	</footer>
</form>


<div class="cal" id="cal-0"></div>


<script>
var startDate = moment('1/2/2000');
var events = JSON.parse( localStorage.getItem('events') || '[]' );
var teachers = JSON.parse( localStorage.getItem('teachers') || '[]' );
var students = JSON.parse( localStorage.getItem('students') || '[]' );


var save = function(){
	localStorage.setItem('events', JSON.stringify(events));
	localStorage.setItem('teachers', JSON.stringify(teachers));
	localStorage.setItem('students', JSON.stringify(students));
}

// upgrade existing events teacher->teachers, student->students
for(i in events){
	var event = events[i];
	if(!event.teachers) event.teachers = [event.teacher];
	if(!event.students) event.students = [event.student];
	if(!event.days) event.days = [event.day];
	delete event.teacher;
	delete event.student;
	delete event.day;
}
save();


var offsetTime = function(t, days){
	var offsetDate = startDate.clone().add(days, 'days'),
	    requestedTime = t.split(':');
	return offsetDate.hour(requestedTime[0]).minute(requestedTime[1]);
}

var todaysEvents = function(){
	var selectedDay = $('#weekday').val();
	return events.filter( function(ev){ return ev.days.indexOf(selectedDay) > -1; } );
}

var eventFromTeachersPerspective = function(event){
	var teacherColumnsConstraint = {
		start: startDate.clone().startOf('day'),
		end: startDate.clone().add(teachers.length-1, 'days').endOf('day')
	};
	return event.teachers.map(function(teacher){
		var dateOffset = teachers.indexOf(teacher),
		    startTime = offsetTime(event.startTime, dateOffset),
		    endTime = offsetTime(event.endTime, dateOffset);
		return {
			id: event.id,
			title: event.students.join(', ') + ': ' + event.activity,
			start: startTime.toDate(),
			end: endTime.toDate(),
			constraint: teacherColumnsConstraint
		};
	});
};
var eventsSourceByTeacher = function(start,end,tz,callback){ 
	callback( 
		todaysEvents().reduce(function(acc, evt){
			return acc.concat( eventFromTeachersPerspective(evt) );
		}, [])
	); 
}

var eventFromStudentsPerspective = function(event){
	var studentColumnsConstraint = {
		start: startDate.clone().add(teachers.length, 'days').startOf('day'),
		end: startDate.clone().add(teachers.length + students.length - 1, 'days').endOf('day')
	};
	return event.students.map(function(student){
		var dateOffset = teachers.length + students.indexOf(student),
		    startTime = offsetTime(event.startTime, dateOffset),
		    endTime = offsetTime(event.endTime, dateOffset);
		
		return {
			id: event.id,
			title: event.teachers.join(', ') + ': ' + event.activity,
			start: startTime.toDate(),
			end: endTime.toDate(),
			constraint: studentColumnsConstraint
		}
	});
};
var eventsSourceByStudent = function(start,end,tz,callback){ 
	callback( 
		todaysEvents().reduce(function(acc, evt){
			return acc.concat( eventFromStudentsPerspective(evt) );
		}, [])
	); 
}

var eventChanged = function(updatedEvent, delta, revertFn, jsEvent, ui, view){
	var originalEvent = events.find( function(ev){ return ev.id == updatedEvent.id; } );
	eventClicked(updatedEvent);

	// Did the student or teacher change?
	var newColumnOffset = updatedEvent.start.diff(startDate, 'days'),
	    originalColumnOffset = updatedEvent.start.clone().subtract(delta).diff(startDate, 'days');

	if( newColumnOffset < teachers.length){
		var selectedTeacher = teachers[ newColumnOffset ],
		    originalTeacher = teachers[ originalColumnOffset ];
		if( originalEvent.teachers.indexOf(selectedTeacher) == -1 ){
			if( !jsEvent.shiftKey ){
				originalEvent.teachers = originalEvent.teachers.filter( function(t){ return t != originalTeacher } );
			}
			originalEvent.teachers.push(selectedTeacher);
		}
	} else {
		var selectedStudent = students[ newColumnOffset - teachers.length ]
		    originalStudent = students[ originalColumnOffset - teachers.length ];
		if( originalEvent.students.indexOf(selectedStudent) == -1 ){
			if( !jsEvent.shiftKey ){
				originalEvent.students = originalEvent.students.filter( function(s){ return s != originalStudent });
			}
			originalEvent.students.push(selectedStudent);
		}
	}

	// Did the start time change?
	originalEvent.startTime = updatedEvent.start.format('HH:mm');

	// Did the end time change?
	originalEvent.endTime = updatedEvent.end.format('HH:mm');

	$('#cal-0').fullCalendar('refetchEvents');
	save();
}

var postRender = function(view, el){
	var t = teachers.length ? teachers : ['&uarr; Add a Teacher'];
	var s = students.length ? students : ['&uarr; Add a Student']
	var headers = t.concat(s);
	$('th.fc-day-header', el).each(function(i, el){
		$(el).html(headers[i] || '');
	});
	$('td.fc-day', el).eq(t.length-1).addClass('last-teacher');
	$('th.fc-day-header', el).eq(t.length-1).addClass('last-teacher');

}

var eventClicked = function(calEvent, jsEvent, view){
	var event = events.find(function(ev){ return ev.id == calEvent.id });
	var form = $('#event-editor');
	for(var key in event){
		$('[name="'+key+'"]', form).val( event[key] );
	}
	$('#addOrEdit').text('Edit');
}

var rangeSelected = function(start, end){
	$('#event-editor input[name="startTime"]').val( start.format('HH:mm') );
	$('#event-editor input[name="endTime"]').val( end.format('HH:mm') );
}

var refreshTeachers = function(){
	var select = $('select[name="teachers"]').empty();
	teachers.forEach(function(teacher){ select.append( $('<option>'+teacher+'</option>') ); });
	$('#cal-0').fullCalendar('destroy');
	redrawCalendar();
	showHideEventForm();
}

var refreshStudents = function(){
	var select = $('select[name="students"]').empty();
	students.forEach(function(student){ select.append( $('<option>'+student+'</option>') ); });
	$('#cal-0').fullCalendar('destroy');
	redrawCalendar();
	showHideEventForm();
}

var refreshDayOfWeek = function(){
    var day = $('#weekday').val();
    $('#event-editor [name="days"]').val(day);
    document.title = "Classroom Schedule: " + day;
}

var showHideEventForm = function(){
	if( students.length && teachers.length ) $('#event-editor').show()
}

var redrawCalendar = function(){
    $('#cal-0').fullCalendar({
    	header: false,
    	defaultDate: startDate,
	defaultView: 'studentsAndTeachers',
	editable: true,
	views: {
		studentsAndTeachers: {
			type: 'agenda',
			duration: { days: (teachers.length || 1) + (students.length || 1) },
		}
	},
	eventSources: [ eventsSourceByStudent, eventsSourceByTeacher ],
	allDaySlot: false,
	slotDuration: "00:20:00",
	minTime: "07:00:00",
	maxTime: "16:00:00",
	overlap: true,
	selectable: true,
	eventResize: eventChanged,
	eventDrop: eventChanged,
	viewRender: postRender,
	eventClick: eventClicked,
	select: rangeSelected
    });
}

var serializeForm = function(form){
	var details = form.serializeArray();
	$('select[multiple]').each(function(){
		details.push( { name: this.name, value: $(this).val()} );
	});
	return details;
}

$(document).ready(function() {

    $('#event-editor')
    	.submit(function(ev){
		ev.preventDefault();
		var details = serializeForm( $(this) );
		var id = parseInt(details.shift().value);
		var event;
		if(!id) {
			event = { id: events.length + 1 };
			events.push(event);
		} else {
			event = events.find(function(ev){ return ev.id == id });
		}

		details.forEach(function(entry){ event[entry.name] = entry.value; });
		save();
		this.reset();
		$('#cal-0').fullCalendar('refetchEvents');
		return false;
	}).on('reset', function(){ 
		$('#addOrEdit').text('Add'); 
		$('[name="id"]', this).val(0);
		var f = this;
		setTimeout( function(){ $('[name="days"]', f).val($('#weekday').val()) }, 0);
	})

    var endTimeInput = $('#event-editor input[name="endTime"]');
    $('#event-editor input[name="startTime"]').change(function(){
    	// was it cleared? clear the endTime
	if( !$(this).val() ){  endTimeInput.val(''); }
	else {
		// compute old time delta or pick default
		var previousStart = $(this).data('previousValue');
		var endTime = endTimeInput.val();
		var delta = ( endTime && previousStart) 
				? moment(endTime, 'HH:mm').diff( moment(previousStart, 'HH:mm'), 'minutes' )
				: 10;
		endTimeInput.val( moment($(this).val(), 'HH:mm').add(delta, 'minutes').format('HH:mm') );
	}
	$(this).data('previousValue', $(this).val());
    });


    $('#new-teacher').submit(function(ev){
    	ev.preventDefault();
	var name = $(this).serializeArray()[0].value;
	teachers.push(name);
	refreshTeachers();
	this.reset();
	$('input', this).eq(0).focus();
	save();
	return false;
    });

    $('#new-student').submit(function(ev){
    	ev.preventDefault();
	var name = $(this).serializeArray()[0].value;
	students.push(name);
	refreshStudents();
	this.reset();
	$('input', this).eq(0).focus();
	save();
	return false;
    });

    $('#weekday').change(function(){
	refreshDayOfWeek();
	$('#cal-0').fullCalendar('refetchEvents');
    })

    $('#clear-all').click(function(){ 
	var confirmed = confirm('Are you sure you want to remove all scheduling data? This cannot be undone.'); 
	if(confirmed){
		localStorage.removeItem('teachers');
		localStorage.removeItem('students');
		localStorage.removeItem('events');
		window.location.reload();
	}
    });

    refreshDayOfWeek();
    redrawCalendar();
    refreshTeachers();
    refreshStudents();

});
</script>

<section class='main-content no-print'>
	<p>
		<strong>Privacy Notice: </strong>Student data is private data, and this tool treats it as such.<br />None of the information you provide is sent from your browser. It is all stored locally in your browser and can be permenantly removed using the <b>Clear All Data</b> button at the top of the page.<br />
		
	</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://JamesMaroney.github.io/random-stuff">Random Stuff</a> is maintained by <a href="https://github.com/JamesMaroney">James Maroney</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a> with slight modifications.</span>
	<br />
	<span class="site-footer-credits">The calendar functionality uses the excellent <a href="https://fullcalendar.io/" target="_blank">FullCalendar</a> tool.</span>
      </footer>

    </section>

  
  </body>
</html>

